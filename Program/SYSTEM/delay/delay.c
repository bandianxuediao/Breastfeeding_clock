#include "includes.h"

static DELAY_DATA DelayData;

//==================================================================================================
//| 函数名称 | Delay_us
//|----------|--------------------------------------------------------------------------------------
//| 函数功能 | 根据输入参数进行延时，单位us
//|----------|--------------------------------------------------------------------------------------
//| 输入参数 | 延时，单位us
//|----------|--------------------------------------------------------------------------------------
//| 返回参数 | 无
//|----------|--------------------------------------------------------------------------------------
//| 函数设计 | 编写人：郑海    时间：2013-08-25
//|----------|--------------------------------------------------------------------------------------
//|   备注   |
//|----------|--------------------------------------------------------------------------------------
//| 修改记录 | 修改人：          时间：         修改内容：
//==================================================================================================
void delay_us(u32 dlynum)
{
	uint32_t  i;
	uint32_t _1us_count = 0;
	RCC_ClocksTypeDef rcc;

	RCC_GetClocksFreq(&rcc);   // 获得系统时钟频率

	_1us_count = rcc.SYSCLK_Frequency / 4000000; /* 1us需要的时钟数 = 系统频率 / 1000000(1us的时钟数) / 4(for循环占用的指令数) */
	_1us_count = dlynum * _1us_count;

	for(i = 0; i < _1us_count; i++)
	{
		;
	}
}
//==================================================================================================
//| 函数名称 | SysTickInit
//|----------|--------------------------------------------------------------------------------------
//| 函数功能 | 配置SysTick定时器
//|----------|--------------------------------------------------------------------------------------
//| 输入参数 | 无
//|----------|--------------------------------------------------------------------------------------
//| 返回参数 | 无
//|----------|--------------------------------------------------------------------------------------
//| 函数设计 | 编写人：郑海    时间：2013-08-25
//|----------|--------------------------------------------------------------------------------------
//|   备注   |
//|----------|--------------------------------------------------------------------------------------
//| 修改记录 | 修改人：          时间：         修改内容：
//==================================================================================================
void SysTickInit(void)
{
	RCC_ClocksTypeDef  rcc_clocks;

	RCC_GetClocksFreq(&rcc_clocks);
	SysTick_Config(rcc_clocks.HCLK_Frequency / 1000); //初始化并使能SysTick定时器
}

//==================================================================================================
//| 函数名称 | SysTickDelay
//|----------|--------------------------------------------------------------------------------------
//| 函数功能 | 延时函数
//|----------|--------------------------------------------------------------------------------------
//| 输入参数 | DelayTime  延时时间,ms
//|----------|--------------------------------------------------------------------------------------
//| 返回参数 | 无
//|----------|--------------------------------------------------------------------------------------
//| 函数设计 | 编写人：郑海    时间：2013-08-25
//|----------|--------------------------------------------------------------------------------------
//|   备注   |
//|----------|--------------------------------------------------------------------------------------
//| 修改记录 | 修改人：          时间：         修改内容：
//==================================================================================================
void delay_ms(u32 DelayTime)
{
	DelayData.delay0_cnt = DelayTime;

	while(DelayData.delay0_cnt);
}

//==================================================================================================
//| 函数名称 | SetSysTickTimer1
//|----------|--------------------------------------------------------------------------------------
//| 函数功能 | 设置滴答定时器1的定时时间
//|----------|--------------------------------------------------------------------------------------
//| 输入参数 | DelayTime  延时时间,ms
//|----------|--------------------------------------------------------------------------------------
//| 返回参数 | 无
//|----------|--------------------------------------------------------------------------------------
//| 函数设计 | 编写人：郑海    时间：2013-08-25
//|----------|--------------------------------------------------------------------------------------
//|   备注   |
//|----------|--------------------------------------------------------------------------------------
//| 修改记录 | 修改人：          时间：         修改内容：
//==================================================================================================
void SetSysTickTimer1(u32 DelayTime)
{
	DelayData.delay1_cnt = DelayTime;
}

//==================================================================================================
//| 函数名称 | GetSysTickTimer1State
//|----------|--------------------------------------------------------------------------------------
//| 函数功能 | 获取滴答定时器1的定时时间是否完成
//|----------|--------------------------------------------------------------------------------------
//| 输入参数 | 无
//|----------|--------------------------------------------------------------------------------------
//| 返回参数 | RUNNING  未达到定时时间
//|          | TIME_OUT 已达到定时时间
//|----------|--------------------------------------------------------------------------------------
//| 函数设计 | 编写人：郑海    时间：2013-08-25
//|----------|--------------------------------------------------------------------------------------
//|   备注   | 与SetSysTickTimer1函数配套使用
//|----------|--------------------------------------------------------------------------------------
//| 修改记录 | 修改人：          时间：         修改内容：
//==================================================================================================
DELAY_STATE GetSysTickTimer1State(void)
{
	if(DelayData.delay1_cnt == 0)
	{
		return TIME_OUT;
	}
	else
	{
		return RUNNING;
	}
}

//==================================================================================================
//| 函数名称 | SetSysTickTimer2
//|----------|--------------------------------------------------------------------------------------
//| 函数功能 | 设置滴答定时器2的定时时间
//|----------|--------------------------------------------------------------------------------------
//| 输入参数 | DelayTime  延时时间
//|----------|--------------------------------------------------------------------------------------
//| 返回参数 | 无
//|----------|--------------------------------------------------------------------------------------
//| 函数设计 | 编写人：郑海    时间：2013-08-25
//|----------|--------------------------------------------------------------------------------------
//|   备注   | 与GetSysTickTimer2State函数配套使用
//|----------|--------------------------------------------------------------------------------------
//| 修改记录 | 修改人：          时间：         修改内容：
//==================================================================================================
void SetSysTickTimer2(u32 DelayTime)
{
	DelayData.delay2_cnt = DelayTime;
}

//==================================================================================================
//| 函数名称 | GetSysTickTimer2State
//|----------|--------------------------------------------------------------------------------------
//| 函数功能 | 获取滴答定时器2的定时时间是否完成
//|----------|--------------------------------------------------------------------------------------
//| 输入参数 | 无
//|----------|--------------------------------------------------------------------------------------
//| 返回参数 | RUNNING  未达到定时时间
//|          | TIME_OUT 已达到定时时间
//|----------|--------------------------------------------------------------------------------------
//| 函数设计 | 编写人：郑海    时间：2013-08-25
//|----------|--------------------------------------------------------------------------------------
//|   备注   | 与SetSysTickTimer2函数配套使用
//|----------|--------------------------------------------------------------------------------------
//| 修改记录 | 修改人：          时间：         修改内容：
//==================================================================================================
DELAY_STATE GetSysTickTimer2State(void)
{
	if(DelayData.delay2_cnt == 0)
	{
		return TIME_OUT;
	}
	else
	{
		return RUNNING;
	}
}

//==================================================================================================
//| 函数名称 | SetSysTickTimer3
//|----------|--------------------------------------------------------------------------------------
//| 函数功能 | 设置滴答定时器3的定时时间
//|----------|--------------------------------------------------------------------------------------
//| 输入参数 | DelayTime  延时时间
//|----------|--------------------------------------------------------------------------------------
//| 返回参数 | 无
//|----------|--------------------------------------------------------------------------------------
//| 函数设计 | 编写人：郑海    时间：2013-08-25
//|----------|--------------------------------------------------------------------------------------
//|   备注   | 与GetSysTickTimer2State函数配套使用,专用于检测总线电压电流状态
//|----------|--------------------------------------------------------------------------------------
//| 修改记录 | 修改人：          时间：         修改内容：
//==================================================================================================
void SetSysTickTimer3(u32 DelayTime)
{
	DelayData.delay3_cnt = DelayTime;
}

//==================================================================================================
//| 函数名称 | GetSysTickTimer3State
//|----------|--------------------------------------------------------------------------------------
//| 函数功能 | 获取滴答定时器3的定时时间是否完成
//|----------|--------------------------------------------------------------------------------------
//| 输入参数 | 无
//|----------|--------------------------------------------------------------------------------------
//| 返回参数 | RUNNING  未达到定时时间
//|          | TIME_OUT 已达到定时时间
//|----------|--------------------------------------------------------------------------------------
//| 函数设计 | 编写人：郑海    时间：2013-08-25
//|----------|--------------------------------------------------------------------------------------
//|   备注   | 与SetSysTickTimer2函数配套使用,专用于检测总线电压电流状态
//|----------|--------------------------------------------------------------------------------------
//| 修改记录 | 修改人：          时间：         修改内容：
//==================================================================================================
DELAY_STATE GetSysTickTimer3State(void)
{
	if(DelayData.delay3_cnt == 0)
	{
		return TIME_OUT;
	}
	else
	{
		return RUNNING;
	}
}
//==================================================================================================
//| 函数名称 | TimingDelayDecrement
//|----------|--------------------------------------------------------------------------------------
//| 函数功能 | t系统递减
//|----------|--------------------------------------------------------------------------------------
//| 输入参数 | 无
//|----------|--------------------------------------------------------------------------------------
//| 返回参数 | 无
//|----------|--------------------------------------------------------------------------------------
//| 函数设计 | 编写人：郑海    时间：2013-08-25
//|----------|--------------------------------------------------------------------------------------
//|   备注   | 每1ms调用1次，与嘀嗒定时器配合使用
//|----------|--------------------------------------------------------------------------------------
//| 修改记录 | 修改人：          时间：         修改内容：
//==================================================================================================
void TimingDelayDecrement(void)
{
	if(DelayData.delay0_cnt != 0)
	{
		DelayData.delay0_cnt--;
	}

	if(DelayData.delay1_cnt != 0)
	{
		DelayData.delay1_cnt--;
	}

	if(DelayData.delay2_cnt != 0)
	{
		DelayData.delay2_cnt--;
	}

	if(DelayData.delay3_cnt != 0)
	{
		DelayData.delay3_cnt--;
	}
}



